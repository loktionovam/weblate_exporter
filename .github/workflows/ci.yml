name: weblate prometheus exporter

on: [push]

jobs:
  build-apps:

    runs-on: ubuntu-20.04
    strategy:
      matrix:
        python-version: ["3.10"]

    steps:
    - uses: actions/checkout@v2
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v2
      with:
        python-version: ${{ matrix.python-version }}
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi
    - name: Test weblate exporter application
      run: |
        make test-apps

  build-images:
    runs-on: ubuntu-20.04
    name: Build weblate exporter image
    needs: [build-apps]
    env:
      WEBLATE_EXPORTER_IMAGE_NAME: loktionovam/weblate_exporter
    steps:
      - uses: actions/checkout@v2.4.0
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1.6.0
      - name: Build and test weblate exporter image
        run: |
          export WEBLATE_EXPORTER_IMAGE_TAG=${GITHUB_REF_NAME}
          make build-images
          python -m pip install --upgrade pip
          if [ -f requirements-test.txt ]; then pip install -r requirements-test.txt; fi
          make test-images
